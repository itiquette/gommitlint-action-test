name: CI

on:
  workflow_dispatch:
    inputs:
      action_version:
        description: 'gommitlint-action ref to test (branch, tag, or SHA)'
        required: false
        default: 'main'
        type: string

permissions:
  contents: read

# NOTE: GIT_DEFAULT_HASH is not set to sha256 because:
# - The repository uses SHA-1 (the default Git object format)
# - SHA-256 object format requires the repository to be initialized with
#   `git init --object-format=sha256`, which this repository was not
# - Setting GIT_DEFAULT_HASH only affects new repository initialization,
#   not existing repositories, so it had no effect here anyway

jobs:
  # Test different commit scenarios
  test-scenarios:
    name: Scenario - ${{ matrix.branch }}
    runs-on: ubuntu-latest
    timeout-minutes: 5
    strategy:
      fail-fast: false
      matrix:
        include:
          - branch: test-valid-conventional
            should_pass: true
          - branch: test-bad-conventional
            should_pass: false
          - branch: test-long-subject
            should_pass: false
          - branch: test-with-config
            should_pass: true
          - branch: test-fixup-commit
            should_pass: false
          - branch: test-scope
            should_pass: true
          - branch: test-base-branch
            should_pass: true
            use_base_branch: true
    steps:
      - name: Checkout ${{ matrix.branch }}
        uses: actions/checkout@v4
        with:
          ref: ${{ matrix.branch }}
          fetch-depth: 0

      - name: Fetch main branch
        if: matrix.use_base_branch
        run: git fetch origin main:main

      - name: Checkout gommitlint-action
        uses: actions/checkout@v4
        with:
          repository: itiquette/gommitlint-action
          ref: ${{ github.event.inputs.action_version || 'main' }}
          path: .github/actions/gommitlint-action

      - name: Validate commits (${{ matrix.branch }})
        id: validate
        uses: ./.github/actions/gommitlint-action
        with:
          count: ${{ matrix.use_base_branch && '' || '2' }}
          base-branch: ${{ matrix.use_base_branch && 'main' || '' }}
        continue-on-error: true

      - name: Check result (${{ matrix.branch }})
        run: |
          if [[ "${{ matrix.should_pass }}" == "true" && "${{ steps.validate.outcome }}" == "failure" ]]; then
            echo "❌ UNEXPECTED: ${{ matrix.branch }} should pass but failed"
            exit 1
          elif [[ "${{ matrix.should_pass }}" == "false" && "${{ steps.validate.outcome }}" == "success" ]]; then
            echo "❌ UNEXPECTED: ${{ matrix.branch }} should fail but passed"
            exit 1
          else
            echo "✅ ${{ matrix.branch }}: outcome as expected"
          fi

  # Test 'range' parameter
  test-range-param:
    name: Param - range
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: test-valid-conventional
          fetch-depth: 0

      - name: Checkout gommitlint-action
        uses: actions/checkout@v4
        with:
          repository: itiquette/gommitlint-action
          ref: ${{ github.event.inputs.action_version || 'main' }}
          path: .github/actions/gommitlint-action

      - name: Validate with range (HEAD~2..HEAD)
        uses: ./.github/actions/gommitlint-action
        with:
          range: HEAD~2..HEAD

  # Test 'config' parameter
  test-config-param:
    name: Param - config
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: test-with-config
          fetch-depth: 0

      - name: Checkout gommitlint-action
        uses: actions/checkout@v4
        with:
          repository: itiquette/gommitlint-action
          ref: ${{ github.event.inputs.action_version || 'main' }}
          path: .github/actions/gommitlint-action

      - name: Validate with config (.gommitlint.yaml)
        uses: ./.github/actions/gommitlint-action
        with:
          config: .gommitlint.yaml
          count: 2

  # Test 'skip-verification' parameter
  test-skip-verification-param:
    name: Param - skip-verification
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: test-valid-conventional
          fetch-depth: 0

      - name: Checkout gommitlint-action
        uses: actions/checkout@v4
        with:
          repository: itiquette/gommitlint-action
          ref: ${{ github.event.inputs.action_version || 'main' }}
          path: .github/actions/gommitlint-action

      - name: Validate with skip-verification (true)
        uses: ./.github/actions/gommitlint-action
        with:
          range: HEAD~1..HEAD
          skip-verification: 'true'

  # Test base-branch parameter
  test-base-branch-param:
    name: Param - base-branch
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: test-base-branch
          fetch-depth: 0

      - name: Fetch main branch
        run: git fetch origin main:main

      - name: Checkout gommitlint-action
        uses: actions/checkout@v4
        with:
          repository: itiquette/gommitlint-action
          ref: ${{ github.event.inputs.action_version || 'main' }}
          path: .github/actions/gommitlint-action

      - name: Validate with base-branch (main)
        uses: ./.github/actions/gommitlint-action
        with:
          base-branch: main

  # Test rules parameter (only run specific rules)
  test-rules-param:
    name: Param - rules
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: test-valid-conventional
          fetch-depth: 0

      - name: Checkout gommitlint-action
        uses: actions/checkout@v4
        with:
          repository: itiquette/gommitlint-action
          ref: ${{ github.event.inputs.action_version || 'main' }}
          path: .github/actions/gommitlint-action

      - name: Validate with rules (conventional,subject)
        uses: ./.github/actions/gommitlint-action
        with:
          range: HEAD~1..HEAD
          rules: conventional,subject

  # Test exclude-rules parameter
  test-exclude-rules-param:
    name: Param - exclude-rules
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: test-valid-conventional
          fetch-depth: 0

      - name: Checkout gommitlint-action
        uses: actions/checkout@v4
        with:
          repository: itiquette/gommitlint-action
          ref: ${{ github.event.inputs.action_version || 'main' }}
          path: .github/actions/gommitlint-action

      - name: Validate with exclude-rules (cryptosignature,signoff)
        uses: ./.github/actions/gommitlint-action
        with:
          range: HEAD~1..HEAD
          exclude-rules: cryptosignature,signoff

  # Test format parameter
  test-format-param:
    name: Param - format
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: test-valid-conventional
          fetch-depth: 0

      - name: Checkout gommitlint-action
        uses: actions/checkout@v4
        with:
          repository: itiquette/gommitlint-action
          ref: ${{ github.event.inputs.action_version || 'main' }}
          path: .github/actions/gommitlint-action

      - name: Validate with format (json)
        uses: ./.github/actions/gommitlint-action
        with:
          range: HEAD~1..HEAD
          format: json

  # Test count parameter
  test-count-param:
    name: Param - count
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: test-valid-conventional
          fetch-depth: 0

      - name: Checkout gommitlint-action
        uses: actions/checkout@v4
        with:
          repository: itiquette/gommitlint-action
          ref: ${{ github.event.inputs.action_version || 'main' }}
          path: .github/actions/gommitlint-action

      - name: Validate with count (2)
        uses: ./.github/actions/gommitlint-action
        with:
          count: 2

  # Test verbose parameter
  test-verbose-param:
    name: Param - verbose
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: test-valid-conventional
          fetch-depth: 0

      - name: Checkout gommitlint-action
        uses: actions/checkout@v4
        with:
          repository: itiquette/gommitlint-action
          ref: ${{ github.event.inputs.action_version || 'main' }}
          path: .github/actions/gommitlint-action

      - name: Validate with verbose (true)
        uses: ./.github/actions/gommitlint-action
        with:
          range: HEAD~1..HEAD
          verbose: 'true'

  # Test log-level parameter
  test-log-level-param:
    name: Param - log-level
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: test-valid-conventional
          fetch-depth: 0

      - name: Checkout gommitlint-action
        uses: actions/checkout@v4
        with:
          repository: itiquette/gommitlint-action
          ref: ${{ github.event.inputs.action_version || 'main' }}
          path: .github/actions/gommitlint-action

      - name: Validate with log-level (debug)
        uses: ./.github/actions/gommitlint-action
        with:
          range: HEAD~1..HEAD
          log-level: debug

  build:
    name: Build
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Build
        run: go build -o hello ./...

      - name: Run
        run: ./hello
